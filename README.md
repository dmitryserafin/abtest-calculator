# Калькулятор A/B Тестов

Этот проект представляет собой FastAPI бэкенд для расчета результатов A/B тестов. Он предоставляет как частотный (z-тест для пропорций), так и Байесовский анализ.

## Основные возможности

*   Расчет p-value и статистической значимости с использованием z-теста.
*   Байесовский анализ с использованием аналитического вывода задних Beta-распределений (априорное Beta(1,1)) для каждой группы.
*   Вычисление вероятности того, что вариант B лучше варианта A (P(B>A)).
*   Расчет ожидаемых потерь для каждого варианта.
*   Предоставление данных для построения распределений плотности вероятности (KDE) и гистограмм для каждой группы и для разницы между ними.

## Установка зависимостей

Для работы проекта необходимы Python 3.8+ и следующие зависимости, которые можно установить с помощью pip:

```bash
pip install -r requirements.txt
```
Файл `requirements.txt` содержит:
*   fastapi
*   uvicorn[standard]
*   scipy
*   numpy

## Запуск локально

Для запуска FastAPI сервера локально используйте uvicorn:

```bash
uvicorn main:app --reload --port 8000
```
Сервер будет доступен по адресу `http://localhost:8000`. Опция `--reload` автоматически перезагружает сервер при изменениях в коде.

## API Эндпоинт: `/calculate`

*   **Метод:** `POST`
*   **Описание:** Принимает данные по двум вариантам (A и B) и возвращает результаты их сравнения.
*   **Тело запроса (JSON):**

    ```json
    {
      "a_success": 100,  // Количество успехов для варианта A
      "a_total": 1000, // Общее количество наблюдений для варианта A
      "b_success": 120,  // Количество успехов для варианта B
      "b_total": 1000  // Общее количество наблюдений для варианта B
    }
    ```

*   **Тело ответа (JSON):**

    Возвращает JSON объект со следующими полями:

    *   `freq_p_value`: p-value из z-теста.
    *   `freq_significant`: `true`, если p-value < 0.05, иначе `false`.
    *   `bayes_prob_b_better`: Байесовская вероятность того, что вариант B лучше варианта A (P(B>A)). Рассчитывается на основе 5,000,000 сэмплов из задних Beta-распределений.
    *   `a_distribution`: Массив значений Y для построения графика KDE (распределения плотности вероятности) для варианта A. Генерируется на основе 50,000 сэмплов.
    *   `b_distribution`: Массив значений Y для KDE для варианта B. Генерируется на основе 50,000 сэмплов.
    *   `x_values`: Массив значений X (ось конверсий, от 0 до 1), общий для `a_distribution` и `b_distribution`.
    *   `a_mean`: Среднее значение заднего распределения для конверсии варианта A. Рассчитывается по 5,000,000 сэмплам.
    *   `b_mean`: Среднее значение заднего распределения для конверсии варианта B. Рассчитывается по 5,000,000 сэмплам.
    *   `a_prob_best`: Байесовская вероятность того, что вариант A лучше варианта B (P(A>B)). Рассчитывается по 5,000,000 сэмплам.
    *   `b_prob_best`: Аналогично `bayes_prob_b_better`.
    *   `a_expected_loss`: Ожидаемые потери при выборе варианта A (если B на самом деле лучше). Рассчитывается по 5,000,000 сэмплам.
    *   `b_expected_loss`: Ожидаемые потери при выборе варианта B (если A на самом деле лучше). Рассчитывается по 5,000,000 сэмплам.
    *   `diff_x`: Массив значений X для графика KDE разницы конверсий (B-A).
    *   `diff_distribution`: Массив значений Y для графика KDE разницы конверсий (B-A). Генерируется на основе 50,000 сэмплов.
    *   `a_hist`: Значения высоты столбцов гистограммы для варианта A. Генерируется на основе 50,000 сэмплов.
    *   `b_hist`: Значения высоты столбцов гистограммы для варианта B. Генерируется на основе 50,000 сэмплов.
    *   `x_hist`: Значения центров бинов для гистограмм `a_hist` и `b_hist`.

### Пример запроса (curl)

```bash
curl -X POST "http://localhost:8000/calculate" -H "Content-Type: application/json" -d '{
  "a_success": 439,
  "a_total": 23214,
  "b_success": 494,
  "b_total": 23095
}'
```

### Пример ответа (сокращенный)

```json
{
  "freq_p_value": 0.057652,
  "freq_significant": false,
  "bayes_prob_b_better": 0.9758, // Примерное значение для данных из curl-запроса
  "a_distribution": [/* ... данные для графика ... */],
  "b_distribution": [/* ... данные для графика ... */],
  "x_values": [/* ... значения по оси X ... */],
  "a_mean": 0.018953,
  "b_mean": 0.021432,
  "a_prob_best": 0.0242,
  "b_prob_best": 0.9758,
  "a_expected_loss": 0.11484,
  "b_expected_loss": 0.000592,
  "diff_x": [/* ... данные для графика ... */],
  "diff_distribution": [/* ... данные для графика ... */],
  "a_hist": [/* ... данные для гистограммы ... */],
  "b_hist": [/* ... данные для гистограммы ... */],
  "x_hist": [/* ... значения по оси X для гистограмм ... */]
}
```

## Методология

*   **Частотный анализ:** Используется стандартный z-тест для сравнения двух пропорций.
*   **Байесовский анализ:**
    *   Для каждого варианта (A и B) предполагается априорное Beta-распределение `Beta(1,1)` для вероятности конверсии.
    *   На основе предоставленных данных (успехи, общее количество) вычисляются параметры точного заднего Beta-распределения для каждого варианта.
    *   Для расчета статистических метрик (P(B>A), средние значения, ожидаемые потери) генерируется большое количество сэмплов (5,000,000) из этих задних распределений с помощью `scipy.stats.beta.rvs()`.
    *   Для генерации данных для визуализаций (KDE, гистограммы) используется подвыборка из 50,000 сэмплов для обеспечения высокой скорости ответа.

## Логирование

Скрипт `main.py` включает детальное логирование времени выполнения каждого основного этапа вычислений. Логи выводятся в консоль сервера и имеют префикс `[LOG]`. Это может быть полезно для отладки или мониторинга производительности в различных окружениях.
